<!DOCTYPE html>
<html>
<head>
    <title>AI MATE</title>
</head>
<body>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let audioChunks = [];
            let isRecording = false;
            const audioThreshold = 0.05; // Threshold for audio level to start recording
            let analyser, mediaRecorder, dataArray;

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    const microphone = audioContext.createMediaStreamSource(stream);
                    microphone.connect(analyser);
                    analyser.fftSize = 512;
                    const bufferLength = analyser.frequencyBinCount;
                    dataArray = new Uint8Array(bufferLength);
                    
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    mediaRecorder.onstop = () => {
                        // Playback or save the recording as needed
                        const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg-3' });
                        const formData = new FormData();
                        formData.append("audio_data", audioBlob);
                        fetch("/record", { method: "POST", body: formData })
                            .then(response => response.blob())
                            .then(blob => {
                                const audioUrl = URL.createObjectURL(blob);
                                new Audio(audioUrl).play();
                            }
                        );
                        audioChunks = [];
                    };

                    processAudioStream();
                });

            function processAudioStream() {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                let average = sum / dataArray.length;
                
                // Check if average volume exceeds threshold
                if (average > (audioThreshold * 255)) {
                    if (!isRecording) {
                        audioChunks = [];
                        mediaRecorder.start();
                        isRecording = true;
                        console.log("Recording started due to voice detected.");
                    }
                } else {
                    if (isRecording) {
                        mediaRecorder.stop();
                        isRecording = false;
                        console.log("Recording stopped.");
                    }
                }

                requestAnimationFrame(processAudioStream);
            }
        });

    </script>
</body>
</html>
